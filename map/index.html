<!doctype html>
<html lang="jp">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="initial-scale=1,user-scalable=no,maximum-scale=1,width=device-width">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="stylesheet" href="./resources/ol.css">
    <link rel="stylesheet" href="resources/fontawesome-all.min.css">
    <link rel="stylesheet" href="./resources/ol-layerswitcher.css">
    <link rel="stylesheet" href="./resources/qgis2web.css">
    <style>
        html,
        body {
            background-color: #ffffff;
        }

        .ol-control>* {
            background-color: #f8f8f8 !important;
            color: #444444 !important;
            border-radius: 0px;
        }

        .ol-attribution a,
        .gcd-gl-input::placeholder,
        .search-layer-input-search::placeholder {
            color: #444444 !important;
        }

        .search-layer-input-search {
            background-color: #f8f8f8 !important;
        }

        .ol-control>*:focus,
        .ol-control>*:hover {
            background-color: rgba(248, 248, 248, 0.7) !important;
        }

        .ol-control {
            background-color: rgba(255, 255, 255, .4) !important;
            padding: 2px !important;
        }
    </style>

    <style>
        html,
        body,
        #map {
            width: 100%;
            height: 100%;
            padding: 0;
            margin: 0;
        }
    </style>



    <title>埼玉県行政区域変遷地図</title>
</head>

<body>

    <!-- ここから追加コード -->
    <div id="infoPanel">
        <h1>埼玉県行政区域変遷地図　<small><small><small><a href="./about.html" target="_blank">この地図について</a></small></small></small></h1>
        <div class="inputRow">

            <label>1879</label>
            <input type="range" id="yearSlider" min="1879" max="2025" value="1889">
            <label>2025</label>
            <input type="number" id="yearInput" min="1879" max="2025" value="1889">
            <label>年</label>
        </div>
    </div>

    <!-- Google Fonts (Noto Sans JP) 読み込み -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP&display=swap" rel="stylesheet">

    <style>
        #infoPanel {
            position: fixed; /* 常に画面上の決まった場所に表示 */
            top: 10px;
            left: 70px;
            z-index: 1000; /* 地図やポップアップより前面に */
            background-color: white;
            border: 1px solid #ccc;
            padding: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            max-width: 1000px;
            font-size: 14px;
            opacity: 0.8;
        }

        .inputRow {
            display: flex;
            align-items: center;
            gap: 15px; /* 要素間の隙間 */
        }

        .inputRow input[type="range"] {
            flex: 1; /* スライダーは幅広く */
        }

        .inputRow input[type="number"] {
            width: 50px;
        }

        .ol-popup {
            width: 300px; /* ポップアップの幅を広くする */
            font-family: 'Noto Sans JP', sans-serif; /* IVSに対応した Noto Sans JP をデフォルトに */
        }

     	/* Noto Sans JP で表示できないものだけ IPAmj明朝 で表示 */
        .ipa {
        	font-family: "IPAmj明朝", "IPAmjMincho", serif;
        }
    </style>
    <!-- ここまで-->
     
    
    <div id="map">
        <div id="popup" class="ol-popup">
            <a href="#" id="popup-closer" class="ol-popup-closer"></a>
            <div id="popup-content"></div>
        </div>
    </div>
    <script src="resources/qgis2web_expressions.js"></script>
    <!--script src="./functions.js"></script-->
    <!-- ここから追加コード -->
    <script>
        var createTextStyle = function (feature, resolution, labelText, labelFont,
            labelFill, placement, bufferColor,
            bufferWidth) {

            if (feature.hide || !labelText) {
                return;
            }

            if (bufferWidth == 0) {
                var bufferStyle = null;
            } else {
                var bufferStyle = new ol.style.Stroke({
                    color: bufferColor,
                    width: bufferWidth
                })
            }

            var textStyle = new ol.style.Text({
                font: labelFont,
                text: labelText,
                textBaseline: "middle",
                textAlign: "center", // "left" から変更
                offsetX: 0, // 8 から変更
                offsetY: 3,
                placement: placement,
                maxAngle: 0,
                fill: new ol.style.Fill({
                    color: labelFill
                }),
                stroke: bufferStyle
            });

            return textStyle;
        };

        function stripe(stripeWidth, gapWidth, angle, color) {
            var canvas = document.createElement('canvas');
            var context = canvas.getContext('2d');
            canvas.width = screen.width;
            canvas.height = stripeWidth + gapWidth;
            context.fillStyle = color;
            context.lineWidth = stripeWidth;
            context.fillRect(0, 0, canvas.width, stripeWidth);
            innerPattern = context.createPattern(canvas, 'repeat');

            var outerCanvas = document.createElement('canvas');
            var outerContext = outerCanvas.getContext('2d');
            outerCanvas.width = screen.width;
            outerCanvas.height = screen.height;
            outerContext.rotate((Math.PI / 180) * angle);
            outerContext.translate(-(screen.width / 2), -(screen.height / 2));
            outerContext.fillStyle = innerPattern;
            outerContext.fillRect(0, 0, screen.width, screen.height);

            return outerContext.createPattern(outerCanvas, 'no-repeat');
        };
    </script>
    <!-- ここまで-->
    <script src="./resources/ol.js"></script>
    <script src="./resources/ol-layerswitcher.js"></script>
    <script src="layers/__1.js"></script>
    <script src="layers/__2.js"></script>
    <script src="layers/__3.js"></script>
    <script src="layers/__4.js"></script>
    <script src="layers/__5.js"></script>
    <script src="layers/__6.js"></script>
    <script src="layers/__7.js"></script>
    <script src="layers/__8.js"></script>
    <script src="layers/__9.js"></script>
    <script src="layers/__10.js"></script>
    <script src="layers/__11.js"></script>
    <script src="layers/__12.js"></script>
    <script src="layers/__13.js"></script>
    <script src="layers/__14.js"></script>
    <script src="layers/__15.js"></script>
    <script src="styles/__1_style.js"></script>
    <script src="styles/__2_style.js"></script>
    <script src="styles/__3_style.js"></script>
    <script src="styles/__4_style.js"></script>
    <script src="styles/__5_style.js"></script>
    <script src="styles/__6_style.js"></script>
    <script src="styles/__7_style.js"></script>
    <script src="styles/__8_style.js"></script>
    <script src="styles/__9_style.js"></script>
    <script src="styles/__10_style.js"></script>
    <script src="styles/__11_style.js"></script>
    <script src="styles/__12_style.js"></script>
    <script src="styles/__13_style.js"></script>
    <script src="styles/__14_style.js"></script>
    <script src="styles/__15_style.js"></script>
    <script src="./layers/layers.js" type="text/javascript"></script>
    <script src="./resources/Autolinker.min.js"></script>
    <script src="./resources/qgis2web.js"></script>

    <!-- ここから追加コード -->
    <script>

        const year_slider = document.getElementById('yearSlider');
        const year_input = document.getElementById('yearInput');

        year_slider.addEventListener('input', () => {
            year_input.value = year_slider.value;
            filterLayer()
        });

        year_input.addEventListener('input', () => {
            const val = Number(year_input.value);
            if (!isNaN(val) && val >= Number(year_slider.min) && val <= Number(year_slider.max)) {
                year_slider.value = val;
                filterLayer()
            }
        });

    // 現在の表示年（スタイル関数から参照）
    let currentYear = Number(year_slider.value);

    // start/end, start2/end2 のどちらかに入っていれば表示
    function isActiveByYear(feature, year) {
        if (isNaN(year)) return false;

        function inRange(startKey, endKey) {
            const rawS = feature.get(startKey);
            const rawE = feature.get(endKey);

            const start = Number(rawS);
            let end = Number(rawE);

            // start 必須
            if (!rawS || isNaN(start) || start === 0) return false;

            // end 省略可（現在まで）
            if (!rawE || isNaN(end) || end === 0) end = 9999;

            return year >= start && year < end;
    }

    // 第1期間 OR 第2期間
    return inRange("start", "end") || inRange("start2", "end2");
    }

    // 既存スタイル（style__1 など）を年フィルタ付きにラップする
    function wrapStyleWithYearFilter(baseStyle) {
    return function(feature, resolution) {
        const active = isActiveByYear(feature, currentYear);

        // ラベル用（あなたの createTextStyle は feature.hide を見ている）
        feature.hide = !active;

        // 地物自体を描画しない（点・線・面すべてに効く）
        if (!active) return null;

        // 元のスタイルを返す（元が配列/単体どちらでもOK）
        return baseStyle(feature, resolution);
    };
    }

    // レイヤ一覧：元の style を保持して、layer.setStyle() で差し替える
    var layerConfigs = [
    { layer: lyr___1,  baseStyle: style___1  },
    { layer: lyr___2,  baseStyle: style___2  },
    { layer: lyr___3,  baseStyle: style___3  },
    { layer: lyr___4,  baseStyle: style___4  },
    { layer: lyr___5,  baseStyle: style___5  },
    { layer: lyr___6,  baseStyle: style___6  },
    { layer: lyr___7,  baseStyle: style___7  },
    { layer: lyr___8,  baseStyle: style___8  },
    { layer: lyr___9,  baseStyle: style___9  },
    { layer: lyr___10, baseStyle: style___10 },
    { layer: lyr___11, baseStyle: style___11 },
    { layer: lyr___12, baseStyle: style___12 },
    { layer: lyr___13, baseStyle: style___13 },
    { layer: lyr___14, baseStyle: style___14 },
    { layer: lyr___15, baseStyle: style___15 }
    ];

    // 初期化：全レイヤのスタイルを差し替え
    layerConfigs.forEach(cfg => {
        cfg.layer.setStyle(wrapStyleWithYearFilter(cfg.baseStyle));
        cfg.layer.set('popuplayertitle', ''); // レイヤ名を表示しない
    });

    // 年変更時：再描画（レイヤ再生成はしない）
    function filterLayer() {
    currentYear = Number(year_slider.value);
    layerConfigs.forEach(cfg => cfg.layer.changed());
    }

    // 初期反映
    filterLayer();

    </script>
    <!-- ここまで -->

</body>
</html>
